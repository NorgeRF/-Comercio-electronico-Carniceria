<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        .payment-container {
            max-width: 800px;
            margin: 40px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .payment-header {
            background: linear-gradient(135deg, var(--primary-color), #a71c1c);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .payment-header i {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .payment-steps {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        .step {
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.7);
        }
        
        .step.active {
            color: white;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        
        .step.active .step-number {
            background: white;
            color: var(--primary-color);
        }
        
        .step-separator {
            width: 50px;
            height: 2px;
            background: rgba(255,255,255,0.2);
            margin: 0 15px;
        }
        
        .payment-body {
            padding: 40px;
        }
        
        .order-summary {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .summary-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .payment-method-card {
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-method-card.active {
            border-color: var(--primary-color);
            background: rgba(198, 40, 40, 0.05);
        }
        
        .payment-method-card i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--dark-color);
        }
        
        .payment-method-card.active i {
            color: var(--primary-color);
        }
        
        .payment-form {
            margin-top: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stripe-element {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        #card-errors {
            color: var(--danger-color);
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .security-info {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 20px;
            margin-top: 30px;
            text-align: center;
        }
        
        .security-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .security-icons i {
            font-size: 1.5rem;
            color: var(--success-color);
        }
        
        .back-to-cart {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner {
            text-align: center;
        }
        
        .loading-spinner i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .success-message i {
            font-size: 4rem;
            color: var(--success-color);
            margin-bottom: 20px;
        }
        
        .bizum-phone-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .bizum-phone-input .country-code {
            background: #f8f9fa;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .bizum-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .bizum-status.pending {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .bizum-status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .bizum-status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            .payment-body {
                padding: 20px;
            }
            
            .row {
                grid-template-columns: 1fr;
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
            }
            
            .bizum-phone-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/<%= whatsapp_number %>?text=Hola,%20tengo%20una%20consulta%20sobre%20el%20pago" 
       class="whatsapp-float" 
       target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1><i class="fas fa-utensils"></i> Carnicer√≠a Tenerife</h1>
                <p>Productos c√°rnicos de m√°xima calidad</p>
            </div>
            <nav class="nav">
                <a href="/"><i class="fas fa-home"></i> Inicio</a>
                <a href="/productos"><i class="fas fa-drumstick-bite"></i> Productos</a>
                <a href="/pedidos"><i class="fas fa-shopping-cart"></i> Pedidos</a>
                <a href="/contacto"><i class="fas fa-phone"></i> Contacto</a>
            </nav>
            <div class="cart-icon">
                <a href="/pedidos">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <h3>Procesando pago...</h3>
            <p>Por favor, no cierres esta ventana.</p>
        </div>
    </div>

    <!-- Payment Container -->
    <section class="payment-process">
        <div class="container">
            <div class="payment-container">
                <!-- Payment Header -->
                <div class="payment-header">
                    <i class="fas fa-lock"></i>
                    <h2>Pago Seguro</h2>
                    <p>Proceso de pago 100% seguro con cifrado SSL</p>
                    
                    <div class="payment-steps">
                        <div class="step active">
                            <div class="step-number">1</div>
                            <span>Carrito</span>
                        </div>
                        <div class="step-separator"></div>
                        <div class="step active">
                            <div class="step-number">2</div>
                            <span>Datos</span>
                        </div>
                        <div class="step-separator"></div>
                        <div class="step active">
                            <div class="step-number">3</div>
                            <span>Pago</span>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Body -->
                <div class="payment-body">
                    <!-- Order Summary -->
                    <div class="order-summary">
                        <h3><i class="fas fa-receipt"></i> Resumen del Pedido</h3>
                        <div id="order-summary">
                            <!-- Se carga con JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Payment Methods -->
                    <h3><i class="fas fa-credit-card"></i> Selecciona M√©todo de Pago</h3>
                    <div class="payment-methods">
                        <div class="payment-method-card" data-method="card" id="card-payment">
                            <i class="fab fa-cc-visa"></i>
                            <h4>Tarjeta de Cr√©dito/D√©bito</h4>
                            <p>Visa, Mastercard, American Express</p>
                        </div>
                        
                        <div class="payment-method-card" data-method="transfer" id="transfer-payment">
                            <i class="fas fa-university"></i>
                            <h4>Transferencia Bancaria</h4>
                            <p>BBVA, Santander, CaixaBank</p>
                        </div>
                        
                        <div class="payment-method-card" data-method="cash" id="cash-payment">
                            <i class="fas fa-money-bill-wave"></i>
                            <h4>Efectivo</h4>
                            <p>Contra reembolso al recibir</p>
                        </div>
                        
                        <% if (bizumEnabled) { %>
                        <div class="payment-method-card" data-method="bizum" id="bizum-payment">
                            <i class="fas fa-mobile-alt"></i>
                            <h4>Bizum</h4>
                            <p>Pago r√°pido desde tu m√≥vil</p>
                        </div>
                        <% } %>
                    </div>
                    
                    <!-- Payment Forms -->
                    <div class="payment-form">
                        <!-- Card Payment Form -->
                        <div id="card-form" style="display: none;">
                            <h4><i class="fas fa-credit-card"></i> Datos de la Tarjeta</h4>
                            <form id="stripe-payment-form">
                                <div class="form-group">
                                    <label for="cardholder-name">Nombre del Titular *</label>
                                    <input type="text" 
                                           id="cardholder-name" 
                                           class="form-control" 
                                           required
                                           placeholder="JUAN PEREZ">
                                </div>
                                
                                <div class="form-group">
                                    <label>N√∫mero de Tarjeta *</label>
                                    <div id="card-element" class="stripe-element">
                                        <!-- Stripe Card Element -->
                                    </div>
                                    <div id="card-errors" role="alert"></div>
                                </div>
                                
                                <div class="row">
                                    <div class="form-group">
                                        <label for="card-expiry">Fecha de Expiraci√≥n *</label>
                                        <div id="card-expiry-element" class="stripe-element">
                                            <!-- Stripe Expiry Element -->
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="card-cvc">CVC *</label>
                                        <div id="card-cvc-element" class="stripe-element">
                                            <!-- Stripe CVC Element -->
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px;">
                                    <i class="fas fa-lock"></i> Pagar Ahora
                                </button>
                            </form>
                        </div>
                        
                        <!-- Transfer Payment Form -->
                        <div id="transfer-form" style="display: none;">
                            <h4><i class="fas fa-university"></i> Datos para Transferencia</h4>
                            <div class="bank-info" style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0;">
                                <p><strong>Banco:</strong> BBVA</p>
                                <p><strong>Titular:</strong> Carnicer√≠a Tenerife S.L.</p>
                                <p><strong>IBAN:</strong> ES12 1234 1234 12 1234567890</p>
                                <p><strong>BIC/SWIFT:</strong> BBVAESMMXXX</p>
                                <p><strong>Concepto:</strong> PEDIDO-[n√∫mero de pedido]</p>
                            </div>
                            <p style="color: #666; font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i> Una vez realizada la transferencia, 
                                env√≠a el comprobante a <strong>transferencias@carniceriatenerife.com</strong>
                            </p>
                            <button class="btn btn-secondary" onclick="confirmTransfer()" style="width: 100%; padding: 15px; margin-top: 20px;">
                                <i class="fas fa-check-circle"></i> Confirmar Transferencia
                            </button>
                        </div>
                        
                        <!-- Cash Payment Form -->
                        <div id="cash-form" style="display: none;">
                            <h4><i class="fas fa-money-bill-wave"></i> Pago en Efectivo</h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0;">
                                <p><i class="fas fa-info-circle"></i> El pago se realizar√° al recibir el pedido.</p>
                                <p>Por favor, ten el importe exacto o aproximado preparado.</p>
                                <p>El repartidor solo lleva cambio limitado.</p>
                            </div>
                            <button class="btn btn-secondary" onclick="confirmCash()" style="width: 100%; padding: 15px;">
                                <i class="fas fa-check-circle"></i> Confirmar Pago en Efectivo
                            </button>
                        </div>
                        
                        <!-- Bizum Payment Form -->
                        <% if (bizumEnabled) { %>
                        <div id="bizum-form" style="display: none;">
                            <h4><i class="fas fa-mobile-alt"></i> Pago con Bizum</h4>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0;">
                                <p><i class="fas fa-info-circle"></i> <strong>Requisitos:</strong></p>
                                <ul style="margin-left: 20px; margin-bottom: 15px;">
                                    <li>Tener la app Bizum instalada en tu m√≥vil</li>
                                    <li>El tel√©fono debe estar asociado a tu cuenta bancaria</li>
                                    <li>Debes tener saldo suficiente</li>
                                </ul>
                                
                                <div class="form-group">
                                    <label for="bizum-phone">Tu tel√©fono Bizum *</label>
                                    <div class="bizum-phone-input">
                                        <span class="country-code">+34</span>
                                        <input type="tel" 
                                               id="bizum-phone" 
                                               class="form-control" 
                                               placeholder="612345678"
                                               pattern="[6-9]\d{8}"
                                               title="Introduce un m√≥vil espa√±ol de 9 d√≠gitos (ej: 612345678)"
                                               required
                                               maxlength="9">
                                    </div>
                                    <small style="color: #666;">Debe ser el mismo tel√©fono que tienes en la app Bizum</small>
                                </div>
                                
                                <div id="bizum-instructions" style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 5px; border-left: 4px solid #007bff;">
                                    <p><i class="fas fa-mobile-alt"></i> <strong>Instrucciones:</strong></p>
                                    <ol style="margin-left: 20px;">
                                        <li>Introduce tu n√∫mero de m√≥vil</li>
                                        <li>Haz clic en "Pagar con Bizum"</li>
                                        <li>Revisa tu m√≥vil para la notificaci√≥n</li>
                                        <li>Confirma el pago en la app Bizum</li>
                                    </ol>
                                </div>
                            </div>
                            
                            <!-- Estado del pago Bizum -->
                            <div id="bizum-status" class="bizum-status" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p id="bizum-status-message"></p>
                                <div id="bizum-status-details"></div>
                            </div>
                            
                            <button type="button" id="pay-with-bizum" class="btn btn-primary" style="width: 100%; padding: 15px; margin-top: 20px;">
                                <i class="fas fa-mobile-alt"></i> Pagar con Bizum
                            </button>
                            
                            <button type="button" id="cancel-bizum" class="btn btn-secondary" style="width: 100%; padding: 15px; margin-top: 10px; display: none;">
                                <i class="fas fa-times"></i> Cancelar Pago Bizum
                            </button>
                        </div>
                        <% } %>
                    </div>
                    
                    <!-- Security Information -->
                    <div class="security-info">
                        <p><i class="fas fa-shield-alt"></i> Pago 100% Seguro</p>
                        <div class="security-icons">
                            <i class="fas fa-lock"></i>
                            <i class="fas fa-user-shield"></i>
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <p style="font-size: 0.9rem; margin-top: 10px;">
                            Tus datos est√°n protegidos con cifrado SSL de 256 bits
                        </p>
                    </div>
                    
                    <!-- Back to Cart -->
                    <div class="back-to-cart">
                        <a href="/pedidos" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver al Carrito
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Success Message -->
    <div class="payment-container" id="success-message" style="display: none;">
        <div class="payment-header" style="background: var(--success-color);">
            <i class="fas fa-check-circle"></i>
            <h2>¬°Pago Completado!</h2>
            <p>Tu pedido ha sido procesado correctamente</p>
        </div>
        <div class="success-message">
            <i class="fas fa-check-circle"></i>
            <h3>Gracias por tu compra</h3>
            <p>Hemos recibido tu pago correctamente.</p>
            <p><strong>C√≥digo de pedido:</strong> <span id="order-code"></span></p>
            <p><strong>M√©todo de pago:</strong> <span id="payment-method"></span></p>
            <p>Te enviaremos un email con los detalles de tu pedido.</p>
            <div style="margin-top: 30px;">
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-home"></i> Volver al Inicio
                </a>
                <button class="btn btn-secondary" onclick="printReceipt()" style="margin-left: 10px;">
                    <i class="fas fa-print"></i> Imprimir Recibo
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-section">
                <h3>Carnicer√≠a Tenerife</h3>
                <p>Productos c√°rnicos de m√°xima calidad desde 2003</p>
            </div>
            <div class="footer-section">
                <h3>Enlaces R√°pidos</h3>
                <a href="/">Inicio</a>
                <a href="/productos">Productos</a>
                <a href="/pedidos">Pedidos</a>
                <a href="/contacto">Contacto</a>
            </div>
            <div class="footer-section">
                <h3>M√©todos de Pago</h3>
                <div class="payment-methods">
                    <i class="fab fa-cc-visa"></i>
                    <i class="fab fa-cc-mastercard"></i>
                    <i class="fab fa-cc-paypal"></i>
                    <i class="fas fa-university"></i>
                    <% if (bizumEnabled) { %>
                    <i class="fas fa-mobile-alt" title="Bizum"></i>
                    <% } %>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; <%= currentYear %> Carnicer√≠a Tenerife. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script src="/script.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Variables globales
        let stripe, card, cardExpiry, cardCvc;
        let selectedPaymentMethod = 'card';
        const stripePublicKey = '<%= stripePublicKey %>';
        const bizumEnabled = <%= bizumEnabled %>;
        
        // Variables para Bizum
        let currentBizumPaymentId = null;
        let bizumCheckInterval = null;
        let bizumOrderCreated = false;
        
        // Cargar datos del pedido desde localStorage
        function loadOrderData() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const orderData = JSON.parse(localStorage.getItem('orderData')) || {};
            
            // Calcular total
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const iva = subtotal * 0.21; // 21% IVA
            const shipping = subtotal > 50 ? 0 : 5;
            const total = subtotal + iva + shipping;
            
            // Mostrar resumen
            const summaryHTML = `
                <div class="summary-item">
                    <span>Subtotal:</span>
                    <span>‚Ç¨${subtotal.toFixed(2)}</span>
                </div>
                <div class="summary-item">
                    <span>IVA (21%):</span>
                    <span>‚Ç¨${iva.toFixed(2)}</span>
                </div>
                <div class="summary-item">
                    <span>Env√≠o:</span>
                    <span>‚Ç¨${shipping.toFixed(2)}</span>
                </div>
                <div class="summary-item">
                    <span>Total:</span>
                    <span>‚Ç¨${total.toFixed(2)}</span>
                </div>
            `;
            
            document.getElementById('order-summary').innerHTML = summaryHTML;
            
            // Actualizar contador del carrito
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelector('.cart-count').textContent = totalItems;
            
            return { cart, orderData, subtotal, iva, shipping, total };
        }
        
        // Inicializar Stripe Elements
        function initStripe() {
            if (!stripePublicKey || stripePublicKey.includes('test')) {
                console.log('Usando Stripe en modo prueba');
            }
            
            stripe = Stripe(stripePublicKey);
            const elements = stripe.elements();
            
            // Crear elementos de tarjeta
            const style = {
                base: {
                    fontSize: '16px',
                    color: '#32325d',
                    fontFamily: 'Roboto, sans-serif',
                    '::placeholder': {
                        color: '#aab7c4'
                    }
                },
                invalid: {
                    color: '#dc3545'
                }
            };
            
            card = elements.create('card', { style: style });
            card.mount('#card-element');
            
            cardExpiry = elements.create('cardExpiry', { style: style });
            cardExpiry.mount('#card-expiry-element');
            
            cardCvc = elements.create('cardCvc', { style: style });
            cardCvc.mount('#card-cvc-element');
            
            // Manejar errores de tarjeta
            card.addEventListener('change', function(event) {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });
        }
        
        // Seleccionar m√©todo de pago
        document.querySelectorAll('.payment-method-card').forEach(card => {
            card.addEventListener('click', function() {
                // Actualizar selecci√≥n visual
                document.querySelectorAll('.payment-method-card').forEach(c => {
                    c.classList.remove('active');
                });
                this.classList.add('active');
                
                // Ocultar todos los formularios
                document.getElementById('card-form').style.display = 'none';
                document.getElementById('transfer-form').style.display = 'none';
                document.getElementById('cash-form').style.display = 'none';
                if (bizumEnabled) {
                    document.getElementById('bizum-form').style.display = 'none';
                    // Detener cualquier verificaci√≥n de Bizum en curso
                    stopBizumCheck();
                }
                
                // Mostrar formulario correspondiente
                selectedPaymentMethod = this.dataset.method;
                
                switch(selectedPaymentMethod) {
                    case 'card':
                        document.getElementById('card-form').style.display = 'block';
                        break;
                    case 'transfer':
                        document.getElementById('transfer-form').style.display = 'block';
                        break;
                    case 'cash':
                        document.getElementById('cash-form').style.display = 'block';
                        break;
                    case 'bizum':
                        if (bizumEnabled) {
                            document.getElementById('bizum-form').style.display = 'block';
                            resetBizumForm();
                        }
                        break;
                }
            });
        });
        
        // ============================================
        // FUNCIONES PARA BIZUM
        // ============================================
        
        // Resetear formulario Bizum
        function resetBizumForm() {
            currentBizumPaymentId = null;
            bizumOrderCreated = false;
            document.getElementById('bizum-phone').value = '';
            document.getElementById('bizum-status').style.display = 'none';
            document.getElementById('pay-with-bizum').style.display = 'block';
            document.getElementById('cancel-bizum').style.display = 'none';
            document.getElementById('bizum-phone').disabled = false;
        }
        
        // Mostrar estado Bizum
        function showBizumStatus(message, type = 'pending') {
            const statusEl = document.getElementById('bizum-status');
            const messageEl = document.getElementById('bizum-status-message');
            
            statusEl.className = `bizum-status ${type}`;
            messageEl.textContent = message;
            statusEl.style.display = 'block';
            
            // Icono seg√∫n tipo
            let icon = 'fa-spinner fa-spin';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-times-circle';
            
            statusEl.innerHTML = `
                <i class="fas ${icon}"></i>
                <p>${message}</p>
                <div id="bizum-status-details"></div>
            `;
        }
        
        // Actualizar detalles del estado Bizum
        function updateBizumStatusDetails(details) {
            const detailsEl = document.getElementById('bizum-status-details');
            detailsEl.innerHTML = details;
        }
        
        // Detener verificaci√≥n de Bizum
        function stopBizumCheck() {
            if (bizumCheckInterval) {
                clearInterval(bizumCheckInterval);
                bizumCheckInterval = null;
            }
        }
        
        // Verificar estado del pago Bizum
        async function checkBizumStatus(paymentId) {
            try {
                console.log(`üì± Verificando estado Bizum: ${paymentId}`);
                
                const response = await fetch(`/api/bizum/check-status/${paymentId}`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Error verificando estado');
                }
                
                console.log(`üì± Estado Bizum ${paymentId}: ${result.status}`);
                
                // Actualizar UI seg√∫n estado
                switch(result.status) {
                    case 'PENDING':
                        showBizumStatus('Esperando confirmaci√≥n en tu m√≥vil...', 'pending');
                        updateBizumStatusDetails(`
                            <p><small>Por favor, abre la app Bizum y confirma el pago</small></p>
                            <p><small>Verificando autom√°ticamente...</small></p>
                        `);
                        return true; // Continuar verificando
                        
                    case 'COMPLETED':
                        showBizumStatus('¬°Pago confirmado correctamente!', 'success');
                        updateBizumStatusDetails(`
                            <p><i class="fas fa-check"></i> El pago ha sido verificado</p>
                            <p><small>Redirigiendo al resumen del pedido...</small></p>
                        `);
                        
                        // Detener verificaci√≥n
                        stopBizumCheck();
                        
                        // Completar el pedido
                        setTimeout(() => {
                            completeOrder(null, 'bizum');
                        }, 2000);
                        return false; // Detener verificaci√≥n
                        
                    case 'FAILED':
                    case 'EXPIRED':
                    case 'CANCELLED':
                        showBizumStatus(`Pago ${result.status.toLowerCase()}. Por favor, intenta con otro m√©todo.`, 'error');
                        updateBizumStatusDetails(`
                            <p><i class="fas fa-exclamation-triangle"></i> ${result.message || 'Error en el pago'}</p>
                            <button class="btn btn-sm btn-secondary" onclick="resetBizumForm()">
                                Intentar de nuevo
                            </button>
                        `);
                        
                        stopBizumCheck();
                        document.getElementById('pay-with-bizum').style.display = 'block';
                        document.getElementById('cancel-bizum').style.display = 'none';
                        document.getElementById('bizum-phone').disabled = false;
                        return false;
                        
                    default:
                        showBizumStatus('Estado desconocido', 'error');
                        return true;
                }
                
            } catch (error) {
                console.error('‚ùå Error verificando estado Bizum:', error);
                showBizumStatus('Error al verificar el pago', 'error');
                return true; // Continuar intentando
            }
        }
        
        // Iniciar pago con Bizum
        async function startBizumPayment() {
            try {
                const { cart, orderData, total } = loadOrderData();
                
                if (cart.length === 0) {
                    alert('El carrito est√° vac√≠o');
                    return;
                }
                
                const phoneInput = document.getElementById('bizum-phone');
                const phone = phoneInput.value.trim();
                
                // Validar tel√©fono
                const phoneRegex = /^[6-9]\d{8}$/;
                if (!phoneRegex.test(phone)) {
                    alert('Por favor, introduce un n√∫mero de m√≥vil espa√±ol v√°lido de 9 d√≠gitos (ej: 612345678)');
                    phoneInput.focus();
                    return;
                }
                
                // Validar monto m√≠nimo para Bizum (0.50‚Ç¨)
                if (total < 0.5) {
                    alert('El monto m√≠nimo para pagar con Bizum es de 0.50‚Ç¨');
                    return;
                }
                
                // Validar monto m√°ximo para Bizum (1000‚Ç¨)
                if (total > 1000) {
                    alert('El monto m√°ximo para pagar con Bizum es de 1000‚Ç¨');
                    return;
                }
                
                // Deshabilitar formulario
                phoneInput.disabled = true;
                document.getElementById('pay-with-bizum').style.display = 'none';
                document.getElementById('cancel-bizum').style.display = 'block';
                
                showBizumStatus('Creando pago Bizum...', 'pending');
                
                // Primero crear el pedido si no se ha creado
                let orderCode = null;
                if (!bizumOrderCreated) {
                    const orderResponse = await createOrder('bizum');
                    if (!orderResponse.success) {
                        throw new Error(orderResponse.message || 'Error creando pedido');
                    }
                    orderCode = orderResponse.order.codigo_pedido;
                    bizumOrderCreated = true;
                }
                
                // Crear pago Bizum
                const response = await fetch('/api/bizum/create-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phone,
                        amount: total,
                        customerName: orderData.cliente_nombre || 'Cliente',
                        customerEmail: orderData.cliente_email || '',
                        orderCode: orderCode
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Error creando pago Bizum');
                }
                
                currentBizumPaymentId = result.paymentId;
                
                showBizumStatus(result.message || 'Pago Bizum iniciado', 'pending');
                updateBizumStatusDetails(`
                    <p><i class="fas fa-mobile-alt"></i> <strong>Tel√©fono:</strong> ${result.phone}</p>
                    <p><i class="fas fa-euro-sign"></i> <strong>Monto:</strong> ‚Ç¨${result.amount.toFixed(2)}</p>
                    <p><small>ID de transacci√≥n: ${result.paymentId}</small></p>
                `);
                
                // Iniciar verificaci√≥n peri√≥dica
                stopBizumCheck(); // Asegurarse de que no hay verificaciones previas
                bizumCheckInterval = setInterval(async () => {
                    const shouldContinue = await checkBizumStatus(currentBizumPaymentId);
                    if (!shouldContinue) {
                        stopBizumCheck();
                    }
                }, 5000); // Verificar cada 5 segundos
                
                // Primera verificaci√≥n inmediata
                setTimeout(() => checkBizumStatus(currentBizumPaymentId), 1000);
                
            } catch (error) {
                console.error('‚ùå Error iniciando pago Bizum:', error);
                showBizumStatus(`Error: ${error.message}`, 'error');
                
                // Rehabilitar formulario
                document.getElementById('bizum-phone').disabled = false;
                document.getElementById('pay-with-bizum').style.display = 'block';
                document.getElementById('cancel-bizum').style.display = 'none';
            }
        }
        
        // Cancelar pago Bizum
        async function cancelBizumPayment() {
            if (!currentBizumPaymentId) {
                resetBizumForm();
                return;
            }
            
            if (confirm('¬øEst√°s seguro de que quieres cancelar el pago Bizum?')) {
                try {
                    showBizumStatus('Cancelando pago...', 'pending');
                    
                    const response = await fetch(`/api/bizum/cancel-payment/${currentBizumPaymentId}`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showBizumStatus('Pago cancelado correctamente', 'success');
                        setTimeout(() => {
                            resetBizumForm();
                        }, 2000);
                    } else {
                        throw new Error(result.message || 'Error cancelando pago');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error cancelando pago Bizum:', error);
                    showBizumStatus(`Error al cancelar: ${error.message}`, 'error');
                }
            }
        }
        
        // ============================================
        // FUNCIONES DE PAGO EXISTENTES
        // ============================================
        
        // Procesar pago con tarjeta
        document.getElementById('stripe-payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const { cart, total } = loadOrderData();
            if (cart.length === 0) {
                alert('El carrito est√° vac√≠o');
                return;
            }
            
            const cardholderName = document.getElementById('cardholder-name').value;
            if (!cardholderName) {
                alert('Por favor, ingresa el nombre del titular de la tarjeta');
                return;
            }
            
            // Mostrar loading
            document.getElementById('loading-overlay').style.display = 'flex';
            
            try {
                // Crear intenci√≥n de pago
                const response = await fetch('/api/create-payment-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: total,
                        orderId: `ORDER-${Date.now()}`,
                        metadata: {
                            cart_items: cart.length,
                            customer_name: cardholderName
                        }
                    })
                });
                
                const { clientSecret, paymentIntentId } = await response.json();
                
                if (!clientSecret) {
                    throw new Error('No se pudo crear la intenci√≥n de pago');
                }
                
                // Confirmar pago con Stripe
                const { paymentIntent, error } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: card,
                        billing_details: {
                            name: cardholderName
                        }
                    }
                });
                
                if (error) {
                    throw new Error(error.message);
                }
                
                if (paymentIntent.status === 'succeeded') {
                    // Pago exitoso
                    completeOrder(paymentIntent.id, 'tarjeta');
                } else {
                    throw new Error('El pago no fue procesado correctamente');
                }
                
            } catch (error) {
                console.error('Error en el pago:', error);
                alert(`Error: ${error.message}`);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });
        
        // Confirmar transferencia
        function confirmTransfer() {
            if (confirm('¬øHas realizado la transferencia bancaria?')) {
                document.getElementById('loading-overlay').style.display = 'flex';
                
                // Simular procesamiento
                setTimeout(() => {
                    completeOrder(null, 'transferencia');
                }, 2000);
            }
        }
        
        // Confirmar efectivo
        function confirmCash() {
            if (confirm('¬øConfirmas que pagar√°s en efectivo al recibir el pedido?')) {
                document.getElementById('loading-overlay').style.display = 'flex';
                
                // Simular procesamiento
                setTimeout(() => {
                    completeOrder(null, 'efectivo');
                }, 2000);
            }
        }
        
        // Crear pedido en el servidor
        async function createOrder(paymentMethod) {
            const { cart, orderData, total } = loadOrderData();
            
            const orderResponse = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...orderData,
                    metodo_pago: paymentMethod,
                    items: cart.map(item => ({
                        producto_id: item.id,
                        cantidad: item.quantity,
                        precio_unitario: item.price,
                        unidad: item.unit
                    })),
                    total: total
                })
            });
            
            return await orderResponse.json();
        }
        
        // Completar pedido
        async function completeOrder(paymentId, paymentMethod) {
            try {
                const { cart, orderData, total } = loadOrderData();
                
                // Si es Bizum, el pedido ya fue creado
                let result;
                if (paymentMethod !== 'bizum' || !bizumOrderCreated) {
                    result = await createOrder(paymentMethod);
                } else {
                    // Para Bizum, ya tenemos el pedido creado
                    result = { success: true, order: { codigo_pedido: 'PENDIENTE' } };
                }
                
                if (result.success) {
                    // Limpiar carrito
                    localStorage.removeItem('cart');
                    localStorage.removeItem('orderData');
                    
                    // Mostrar mensaje de √©xito
                    document.querySelector('.payment-process').style.display = 'none';
                    document.getElementById('success-message').style.display = 'block';
                    document.getElementById('order-code').textContent = result.order.codigo_pedido;
                    document.getElementById('payment-method').textContent = 
                        paymentMethod === 'tarjeta' ? 'Tarjeta de cr√©dito/d√©bito' :
                        paymentMethod === 'transferencia' ? 'Transferencia bancaria' :
                        paymentMethod === 'efectivo' ? 'Efectivo' :
                        paymentMethod === 'bizum' ? 'Bizum' : paymentMethod;
                    
                    // Ocultar loading
                    document.getElementById('loading-overlay').style.display = 'none';
                    
                    // Detener verificaci√≥n de Bizum si est√° activa
                    if (paymentMethod === 'bizum') {
                        stopBizumCheck();
                    }
                } else {
                    throw new Error(result.error || 'Error al crear el pedido');
                }
                
            } catch (error) {
                console.error('Error al completar pedido:', error);
                alert(`Error: ${error.message}`);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // Imprimir recibo
        function printReceipt() {
            const printContent = `
                <html>
                <head>
                    <title>Recibo - Carnicer√≠a Tenerife</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .receipt { max-width: 400px; margin: 0 auto; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header h2 { color: #c62828; margin: 0; }
                        .details { margin: 20px 0; }
                        .details p { margin: 5px 0; }
                        .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="header">
                            <h2>Carnicer√≠a Tenerife</h2>
                            <p>C/ Principal, 123 - Santa Cruz de Tenerife</p>
                            <p>Tel: 922 123 456 | Email: info@carniceriatenerife.com</p>
                        </div>
                        <div class="details">
                            <p><strong>C√≥digo:</strong> ${document.getElementById('order-code').textContent}</p>
                            <p><strong>Fecha:</strong> ${new Date().toLocaleString()}</p>
                            <p><strong>M√©todo de pago:</strong> ${document.getElementById('payment-method').textContent}</p>
                            <p><strong>Estado:</strong> Confirmado</p>
                        </div>
                        <div class="footer">
                            <p>¬°Gracias por su compra!</p>
                            <p>Para consultas: 922 123 456</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderData();
            
            if (stripePublicKey && !stripePublicKey.includes('test_')) {
                initStripe();
            }
            
            // Seleccionar tarjeta por defecto
            document.getElementById('card-payment').click();
            
            // Event listeners para Bizum
            if (bizumEnabled) {
                document.getElementById('pay-with-bizum').addEventListener('click', startBizumPayment);
                document.getElementById('cancel-bizum').addEventListener('click', cancelBizumPayment);
                
                // Permitir Enter en el campo de tel√©fono
                document.getElementById('bizum-phone').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        startBizumPayment();
                    }
                });
            }
        });
    </script>
</body>
</html>